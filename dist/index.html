<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta http-equiv="X-UA-Compatible" content="ie=edge" />
        <title>Test Page</title>
        <style>
            * {
                box-sizing: border-box;
            }
            html,
            body {
                width: 100%;
                height: 100%;
            }
            .err {
                color: red;
            }
            .warn {
                color: orange;
            }
        </style>
    </head>
    <body>
        <div id="log"></div>

        <script>
            const logElement = document.getElementById("log");
            const MAX_LOG_ELEMENTS = 100;
            const logMessages = [];

            function addMessage(msg, level = 0) {
                const el = document.createElement("p");
                el.textContent = msg;
                if (level === 1) {
                    el.classList.add("warn");
                }
                if (level === 2) {
                    el.classList.add("err");
                }
                const firstChild = logElement.firstChild;
                if (firstChild) {
                    logElement.insertBefore(el, firstChild);
                } else {
                    logElement.appendChild(el);
                }

                logMessages.push(el);

                while (logMessages.length > MAX_LOG_ELEMENTS) {
                    const elementToRemove = logMessages.shift();
                    logElement.removeChild(elementToRemove);
                }
            }

            const consoleLog = window.console.log;
            const consoleWarning = window.console.log;
            const consoleError = window.console.log;

            window.console.log = msg => addMessage(msg, 0) && consoleLog(msg);
            window.console.warning = msg =>
                addMessage(msg, 1) && consoleWarning(msg);
            window.console.error = msg =>
                addMessage(msg, 2) && consoleError(msg);
        </script>

        <script src="main.js"></script>

        <script>
            let asd = null,
                asd2 = null;
            setTimeout(async () => {
                // Create authentication request.
                const authRequestBody = new URLSearchParams();
                authRequestBody.append("client_id", 5662);
                authRequestBody.append(
                    "client_secret",
                    "gZ24oMIPpD4v97N1nv9GnDLcTPpY2hV9"
                );
                authRequestBody.append("grant_type", "client_credentials");

                // Fetch JWT token from authentication server.
                const authResponse = await fetch(
                    "http://auth.samuel.noccela.xyz/connect/token",
                    {
                        method: "post",
                        headers: {
                            "Content-Type": "application/x-www-form-urlencoded"
                        },
                        body: authRequestBody
                    }
                );

                const {
                    expires_in: tokenExpiration,
                    access_token: accessToken
                } = await authResponse.json();

                // Create NCC websocket object.
                const ncc = NccIntegration.createConnection(
                    "ws://partner.samuel.noccela.xyz/api/partner/realtime/listen"
                );

                // Connect to Noccela Cloud.
                try {
                    await ncc.connect(accessToken);
                } catch (err) {
                    alert(`Error while connecting: ${err}`);
                    return;
                }

                // Create callback that will be called with real-time location data
                // for registered devices.
                const callback = payload => {
                    for (const locationUpdate of payload) {
                        console.log(
                            `DeviceId: ${locationUpdate.deviceId}, x: ${locationUpdate.x}, y: ${locationUpdate.y}, z: ${locationUpdate.z}`
                        );
                    }
                };

                // Register the callback and filtering information.
                asd2 = ncc.register(
                    NccIntegration.EVENT_TYPES["LOCATION_UPDATE"],
                    1, // Account
                    1, // site
                    { deviceIds: [1000500916] }, // Additional filters, like device ids.
                    callback
                );

                asd = ncc;
            }, 1000);
        </script>
        <button onclick="asd.close()">close</button>
        <button onclick="asd.unregister(asd2)">unregister</button>
    </body>
</html>
